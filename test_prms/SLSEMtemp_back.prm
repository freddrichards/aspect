# A description of convection in a 3d spherical shell with 
# a prescribed initial condition based on the shear wave
# velocity model S20RTS. Back-advection switched on.

# Define the number of space dimensions we would like to 
# work in:
set Dimension                              = 3 

# Specify the time you want to let the model run for in 
# years and the output directory. Here we only calculate
# the instantaneous solution.
# set End time                               = 0
set Start time                             = 0
set End time                               = 15e6
set Use years in output instead of seconds = true
#set Output directory                       = output-SEMUCBSL-back
set Output directory                       = output-SEMUCBSL-gfmincomp-back-stkcglith

#Extra parameters from Jacky's changes (github)
set CFL number                             = 1.0
set Adiabatic surface temperature          = 1613.0
set Nonlinear solver scheme                = no Stokes

# The following variables describe how the pressure should
# be normalized. Here, we choose a zero average pressure
# at the surface of the domain 
set Pressure normalization                 = surface
set Surface pressure                       = 0

subsection Termination criteria
  set Termination criteria      = end step
  set End step                  = 0

end

# Here we specify the residual tolerance for the linear solver.
subsection Solver parameters
  subsection Stokes solver parameters
    set Use full A block as preconditioner = true
    set Linear solver tolerance = 1e-4
	set Linear solver A block tolerance = 0.5
    set GMRES solver restart length = 500
	set Maximum number of expensive Stokes solver steps = 10000
  end
end

subsection Nullspace removal
	set Remove nullspace = net rotation
end


# Here we specify the geometry of the domain, which is 
# a spherical shell with inner radius of 3481km and 
# outer radius of 6371km
subsection Geometry model
  set Model name = spherical shell
  subsection Spherical shell
    set Inner radius  = 3481000
    set Outer radius  = 6371000
  end
end

# This section specifies the temperature at the boundary of 
# the domain. Here we set the temperature to be constant,
# but different from the reference temperature to approximate
# boundary layers.
# subsection Boundary temperature model
#   set Fixed temperature boundary indicators = 0, 1
#   set List of model names = spherical constant
#   subsection Spherical constant
#     set Inner temperature = 2000
#     set Outer temperature = 1000
#   end
# end

# This section describes the gravity field, which is pointing
# away from the Earth's center with the same magnitude of 9.81 m/s^2
# everywhere
subsection Gravity model
  set Model name = radial constant
  subsection Radial constant
    # set Magnitude = -9.81
    set Magnitude = 9.81
  end
end

# This section prescribes the initial condition in the composition
# field, which is chosen as an ascii file generated in /Users/fredrichards/Desktop/
# HarvardPostdoc/ASPECT_Setup/MIXED_SLB2013sv_SEMUCB_temp_linear_YT16_400km_NODISCONT.
# subsection Initial composition model
#   set Model name = ascii data
#   subsection Ascii data model
# 
# subsection Compositional fields
# 	set Number of fields = 1
# 	set Names of fields = basalt
# end
#
# # The two input options here are location of data file
#     set Data directory       		      =  /Users/fredrichards/aspect/data/initial-composition/ascii-data/test/
#     set Data file name                = llsvp_2600.txt
#
#   end
# end

# This section prescribes the initial condition in the temperature
# field, which is chosen as an ascii file generated in /Users/fredrichards/Desktop/
# HarvardPostdoc/ASPECT_Setup/MIXED_SLB2013sv_SEMUCB_temp_linear_YT16_400km_NODISCONT.
subsection Initial temperature model
  set Model name = ascii data
  subsection Ascii data model

# The two input options here are location of data file
    set Data directory       		      =  /Users/fredrichards/aspect/data/initial-temperature/ascii-data/test/
    set Data file name                = temp_stkcg_py0ba100_q4_2600.txt

  end
end


# The material model is based on the simple material model, which assumes
# a constant density, and other parameters as stated below.
# subsection Material model
#   set Model name = simple
#     subsection Simple model
#     set Reference density                 = 3300
#     set Viscosity                         = 1e21
#     set Thermal expansion coefficient     = 3e-5
#     set Reference temperature             = 1613
#     set Thermal conductivity              = 0
#     set Reference specific heat           = 1250
#   end
# end
subsection Material model
  set Model name = Steinberger
  subsection Steinberger model
    set Data directory                                = $ASPECT_SOURCE_DIR/data/material-model/steinberger/
    set Lateral viscosity file name                   = temp-viscosity-prefactor.txt
    set Material file names                           = pyr-ringwood88.txt,
    set Radial viscosity file name                    = radial-visc.txt

    set Maximum lateral viscosity variation           = 1e2
    set Maximum viscosity                             = 1e23
    set Minimum viscosity                             = 1e19

    set Use lateral average temperature for viscosity = true
    set Number lateral average bands                  = 10

    set Reference viscosity                           = 1e21
    set Bilinear interpolation                        = true
    set Latent heat                                   = false
  end
end
# subsection Material model
#   set Model name = depth dependent
#   subsection Depth dependent model
#     set Base model = Glisovic Forte
#     set Depth dependence method = File
#     set Data directory = $ASPECT_SOURCE_DIR/data/material-model/gfm/
#     set Viscosity depth file = S40_visc_new.txt
#   end
#
#   subsection Glisovic Forte model
#     set Thermal viscosity exponent    = 0
#
#     set Reference temperature         = 1600
#     set Viscosity           		  = 8e21   #changed from reference
#     set Reference density             = 3300
#
#     set Thermal conductivity constant = true #false
#     set Thermal conductivity          = 0
#
#     set Reference specific heat       = 1250
#     set Thermal expansion constant    = false
#   end
# end

# For this calculation we only do 2 global refinement steps. This resolution
# is too low to fully resolve the mantle flow, however it does capture
# the main features.
subsection Mesh refinement
  set Initial global refinement          = 2
  set Initial adaptive refinement        = 0
  set Strategy = velocity
  set Time steps between mesh refinement       = 2
  set Refinement fraction                      = 0.1
  set Coarsening fraction                      = 0.0
end

# We assume free slip at the inner and outer boundary
subsection Boundary velocity model
  set Tangential velocity boundary indicators = top, bottom
  # set Zero velocity boundary indicators = 1
end


# We output the density, velocity, dynamic topography, geoid and heat flux density
# for plotting. 
subsection Postprocess
  set List of postprocessors = geoid, velocity statistics, heat flux map, heat flux statistics, dynamic topography, visualization, basic statistics

  subsection Visualization
    set Output format                 = vtu
    set List of output variables      = geoid, dynamic topography, heat flux map, density,viscosity, gravity
    set Time between graphical output = 0
    set Number of grouped files       = 1 
  end
end
